var E = require('./shared.js');

// =============================================================================
//  服务端
// =============================================================================
MAX_PLAYERS = 4;
numPlayers = 0;
FRAME_RATE = 0;
GAME_LOOP = null;

// 硬编码地图
map = [
  [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
  [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
  [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0]
]

function initGame() {
  E.prepID();
  E.initBoxes(map);

  FRAME_RATE = 20;
  GAME_LOOP = setInterval(E.tick, 1000.0 / FRAME_RATE);
}

function init() {
  initGame();
  // 网络
  let io = require('socket.io')(8081);
  io.on('connection', (socket) => {
    socket.on('stream', () => {
      E.sendGameData(socket);
    });
    socket.on('opcode', (msg) => {
      // handleMessage(msg);
    });
    socket.on('disconnect', () => {});

    E.spawnPlayer(socket.handshake.address);
  });
}

init();
